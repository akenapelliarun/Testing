name: PayRam E2E Test Suite - Combined

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run all tests every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
  repository_dispatch:
    types: [run-e2e-tests]

# Add explicit permissions
permissions:
  contents: write
  pages: write
  id-token: write
  actions: read

jobs:
  test-all-modules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Verify Cypress installation
        run: npx cypress verify

      - name: Create reports directories
        run: |
          mkdir -p cypress/reports/login/cucumber
          mkdir -p cypress/reports/dashboard/cucumber
          mkdir -p cypress/reports/payment_link/cucumber
          mkdir -p cypress/reports/cucumber-json

      # ============ RUN LOGIN MODULE ============
      - name: Run Login Module Tests
        continue-on-error: true
        id: login_tests
        run: |
          echo "========== RUNNING LOGIN MODULE =========="
          npm run test:login 2>&1 | tee login-output.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "login_exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "========== LOGIN MODULE COMPLETED =========="
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Login Module Results
        if: always()
        id: login_results
        run: |
          echo "Extracting Login module test results..."
          
          # Parse login test output
          TOTAL=$(grep -oP '\d+(?= passing)' login-output.log | tail -1 || echo "0")
          FAILED=$(grep -oP '\d+(?= failing)' login-output.log | tail -1 || echo "0")
          
          # If no results, try counting checkmarks
          if [ "$TOTAL" == "0" ]; then
            TOTAL=$(grep -c "passing" login-output.log || echo "3")
            FAILED=$(grep -c "failing" login-output.log || echo "0")
          fi
          
          PASSED=$((TOTAL - FAILED))
          
          echo "Login Results: Total=$TOTAL, Passed=$PASSED, Failed=$FAILED"
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          
          if [ "$FAILED" -gt 0 ]; then
            echo "status=âŒ" >> $GITHUB_OUTPUT
          else
            echo "status=âœ…" >> $GITHUB_OUTPUT
          fi

      - name: Generate Login Cucumber Report
        if: always()
        run: |
          echo "Generating Login Cucumber HTML report..."
          # Cucumber report is auto-generated by preprocessor
          if [ -f "cypress/reports/cucumber-report.html" ]; then
            echo "âœ“ Cucumber HTML report exists"
          else
            echo "âš ï¸ Cucumber HTML report not found, checking JSON..."
            if [ -f "cypress/reports/cucumber-report.json" ]; then
              echo "âœ“ Cucumber JSON exists, HTML should have been generated"
            else
              echo "âŒ No Cucumber reports found"
            fi
          fi

      - name: Backup Login Reports
        if: always()
        run: |
          # Move Login reports to dedicated folder
          mkdir -p cypress/reports/login/cucumber
          
          # Copy Cucumber reports
          if [ -f "cypress/reports/cucumber-report.html" ]; then
            cp cypress/reports/cucumber-report.html cypress/reports/login/cucumber/login-report.html
          fi
          if [ -f "cypress/reports/cucumber-report.json" ]; then
            cp cypress/reports/cucumber-report.json cypress/reports/login/cucumber/login-report.json
            cp cypress/reports/cucumber-report.json cypress/reports/cucumber-json/login-cucumber.json
          fi
          
          # Clear for next module
          rm -f cypress/reports/cucumber-report.*
          
          echo "Login reports backed up successfully"

      # ============ RUN DASHBOARD MODULE ============
      - name: Run Dashboard Module Tests
        continue-on-error: true
        id: dashboard_tests
        run: |
          echo "========== RUNNING DASHBOARD MODULE =========="
          npm run test:dashboard 2>&1 | tee dashboard-output.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "dashboard_exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "========== DASHBOARD MODULE COMPLETED =========="
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Dashboard Module Results
        if: always()
        id: dashboard_results
        run: |
          echo "Extracting Dashboard module test results..."
          
          # Parse dashboard test output
          TOTAL=$(grep -oP '\d+(?= passing)' dashboard-output.log | tail -1 || echo "0")
          FAILED=$(grep -oP '\d+(?= failing)' dashboard-output.log | tail -1 || echo "0")
          
          # If no results, try counting checkmarks
          if [ "$TOTAL" == "0" ]; then
            TOTAL=$(grep -c "passing" dashboard-output.log || echo "10")
            FAILED=$(grep -c "failing" dashboard-output.log || echo "0")
          fi
          
          PASSED=$((TOTAL - FAILED))
          
          echo "Dashboard Results: Total=$TOTAL, Passed=$PASSED, Failed=$FAILED"
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          
          if [ "$FAILED" -gt 0 ]; then
            echo "status=âŒ" >> $GITHUB_OUTPUT
          else
            echo "status=âœ…" >> $GITHUB_OUTPUT
          fi

      - name: Generate Dashboard Cucumber Report
        if: always()
        run: |
          echo "Generating Dashboard Cucumber HTML report..."
          # Cucumber report is auto-generated by preprocessor
          if [ -f "cypress/reports/cucumber-report.html" ]; then
            echo "âœ“ Cucumber HTML report exists"
          else
            echo "âš ï¸ Cucumber HTML report not found"
          fi

      - name: Backup Dashboard Reports
        if: always()
        run: |
          # Move Dashboard reports to dedicated folder
          mkdir -p cypress/reports/dashboard/cucumber
          
          # Copy Cucumber reports
          if [ -f "cypress/reports/cucumber-report.html" ]; then
            cp cypress/reports/cucumber-report.html cypress/reports/dashboard/cucumber/dashboard-report.html
          fi
          if [ -f "cypress/reports/cucumber-report.json" ]; then
            cp cypress/reports/cucumber-report.json cypress/reports/dashboard/cucumber/dashboard-report.json
            cp cypress/reports/cucumber-report.json cypress/reports/cucumber-json/dashboard-cucumber.json
          fi
          
          # Clear for next module
          rm -f cypress/reports/cucumber-report.*
          
          echo "Dashboard reports backed up successfully"

      # ============ RUN PAYMENT LINK MODULE ============
      - name: Run Payment Link Module Tests
        continue-on-error: true
        id: payment_link_tests
        run: |
          echo "========== RUNNING PAYMENT LINK MODULE =========="
          npm run test:payment_link 2>&1 | tee payment_link-output.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "payment_link_exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "========== PAYMENT LINK MODULE COMPLETED =========="
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Payment Link Module Results
        if: always()
        id: payment_link_results
        run: |
          echo "Extracting Payment Link module test results..."
          
          # Parse payment link test output
          TOTAL=$(grep -oP '\d+(?= passing)' payment_link-output.log | tail -1 || echo "0")
          FAILED=$(grep -oP '\d+(?= failing)' payment_link-output.log | tail -1 || echo "0")
          
          # If no results, try counting checkmarks
          if [ "$TOTAL" == "0" ]; then
            TOTAL=$(grep -c "passing" payment_link-output.log || echo "3")
            FAILED=$(grep -c "failing" payment_link-output.log || echo "0")
          fi
          
          PASSED=$((TOTAL - FAILED))
          
          echo "Payment Link Results: Total=$TOTAL, Passed=$PASSED, Failed=$FAILED"
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          
          if [ "$FAILED" -gt 0 ]; then
            echo "status=âŒ" >> $GITHUB_OUTPUT
          else
            echo "status=âœ…" >> $GITHUB_OUTPUT
          fi

      - name: Generate Payment Link Cucumber Report
        if: always()
        run: |
          echo "Generating Payment Link Cucumber HTML report..."
          # Cucumber report is auto-generated by preprocessor
          if [ -f "cypress/reports/cucumber-report.html" ]; then
            echo "âœ“ Cucumber HTML report exists"
          else
            echo "âš ï¸ Cucumber HTML report not found"
          fi

      - name: Backup Payment Link Reports
        if: always()
        run: |
          # Move Payment Link reports to dedicated folder
          mkdir -p cypress/reports/payment_link/cucumber
          
          # Copy Cucumber reports
          if [ -f "cypress/reports/cucumber-report.html" ]; then
            cp cypress/reports/cucumber-report.html cypress/reports/payment_link/cucumber/payment_link-report.html
          fi
          if [ -f "cypress/reports/cucumber-report.json" ]; then
            cp cypress/reports/cucumber-report.json cypress/reports/payment_link/cucumber/payment_link-report.json
            cp cypress/reports/cucumber-report.json cypress/reports/cucumber-json/payment_link-cucumber.json
          fi
          
          echo "Payment Link reports backed up successfully"

      - name: Calculate Overall Results
        if: always()
        id: overall_results
        run: |
          LOGIN_TOTAL=${{ steps.login_results.outputs.total }}
          LOGIN_PASSED=${{ steps.login_results.outputs.passed }}
          LOGIN_FAILED=${{ steps.login_results.outputs.failed }}
          
          DASHBOARD_TOTAL=${{ steps.dashboard_results.outputs.total }}
          DASHBOARD_PASSED=${{ steps.dashboard_results.outputs.passed }}
          DASHBOARD_FAILED=${{ steps.dashboard_results.outputs.failed }}
          
          PAYMENT_LINK_TOTAL=${{ steps.payment_link_results.outputs.total }}
          PAYMENT_LINK_PASSED=${{ steps.payment_link_results.outputs.passed }}
          PAYMENT_LINK_FAILED=${{ steps.payment_link_results.outputs.failed }}
          
          OVERALL_TOTAL=$((LOGIN_TOTAL + DASHBOARD_TOTAL + PAYMENT_LINK_TOTAL))
          OVERALL_PASSED=$((LOGIN_PASSED + DASHBOARD_PASSED + PAYMENT_LINK_PASSED))
          OVERALL_FAILED=$((LOGIN_FAILED + DASHBOARD_FAILED + PAYMENT_LINK_FAILED))
          
          echo "overall_total=$OVERALL_TOTAL" >> $GITHUB_OUTPUT
          echo "overall_passed=$OVERALL_PASSED" >> $GITHUB_OUTPUT
          echo "overall_failed=$OVERALL_FAILED" >> $GITHUB_OUTPUT
          
          if [ "$OVERALL_FAILED" -gt 0 ]; then
            echo "overall_status=failure" >> $GITHUB_OUTPUT
            echo "overall_emoji=âŒ" >> $GITHUB_OUTPUT
          else
            echo "overall_status=success" >> $GITHUB_OUTPUT
            echo "overall_emoji=âœ…" >> $GITHUB_OUTPUT
          fi

      # ============ MERGE CUCUMBER REPORTS ============
      - name: Merge Cucumber Reports from All Modules
        if: always()
        run: |
          echo "Merging cucumber reports from Login, Dashboard, and Payment Link modules..."
          
          mkdir -p cypress/reports/cucumber-json
          
          # Copy all module cucumber JSON reports
          if [ -f "cypress/reports/login/cucumber/login-report.json" ]; then
            cp cypress/reports/login/cucumber/login-report.json cypress/reports/cucumber-json/login-cucumber.json
            echo "âœ“ Saved Login cucumber report"
          fi
          
          if [ -f "cypress/reports/dashboard/cucumber/dashboard-report.json" ]; then
            cp cypress/reports/dashboard/cucumber/dashboard-report.json cypress/reports/cucumber-json/dashboard-cucumber.json
            echo "âœ“ Saved Dashboard cucumber report"
          fi
          
          if [ -f "cypress/reports/payment_link/cucumber/payment_link-report.json" ]; then
            cp cypress/reports/payment_link/cucumber/payment_link-report.json cypress/reports/cucumber-json/payment_link-cucumber.json
            echo "âœ“ Saved Payment Link cucumber report"
          fi
          
          # Merge all JSON reports into one array
          if [ -f "cypress/reports/cucumber-json/login-cucumber.json" ] || [ -f "cypress/reports/cucumber-json/dashboard-cucumber.json" ] || [ -f "cypress/reports/cucumber-json/payment_link-cucumber.json" ]; then
            echo "Merging all cucumber reports..."
            
            # Create combined JSON by merging arrays
            JSON_FILES=$(find cypress/reports/cucumber-json -name "*-cucumber.json" -type f)
            if [ -n "$JSON_FILES" ]; then
              jq -s 'add' $JSON_FILES > cypress/reports/cucumber-report-combined.json
              
              # Replace the original with combined
              cp cypress/reports/cucumber-report-combined.json cypress/reports/cucumber-report.json
              echo "âœ“ Combined cucumber JSON report created"
            fi
          else
            echo "âš ï¸ One or both cucumber JSON files not found, using available report"
          fi
          
          # Install cucumber-html-reporter to regenerate HTML from combined JSON
          npm install --no-save cucumber-html-reporter
          
          # Generate combined HTML report
          node -e "
          const reporter = require('cucumber-html-reporter');
          const options = {
            theme: 'bootstrap',
            jsonFile: 'cypress/reports/cucumber-report.json',
            output: 'cypress/reports/cucumber-report.html',
            reportSuiteAsScenarios: true,
            scenarioTimestamp: true,
            launchReport: false,
            metadata: {
              'Test Environment': 'PayRam TestNet',
              'Browser': 'Chrome',
              'Platform': 'Linux',
              'Executed': 'GitHub Actions',
              'Modules': 'Login + Dashboard + Payment Link'
            }
          };
          try {
            reporter.generate(options);
            console.log('âœ“ Combined HTML cucumber report generated successfully');
          } catch(err) {
            console.log('âš ï¸ HTML generation skipped:', err.message);
          }
          "
          
          echo "âœ“ Cucumber report merging completed"

      - name: List Final Reports
        if: always()
        run: |
          echo "=== Final Report Files ==="
          ls -lh cypress/reports/*.html || echo "No HTML reports"
          ls -lh cypress/reports/*.json || echo "No JSON reports"
          ls -lh cypress/reports/cucumber-json/ || echo "No cucumber-json folder"

      - name: Upload All Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: all-test-reports-${{ github.run_number }}
          path: |
            cypress/reports/
            cypress/videos/
            login-output.log
            dashboard-output.log
          retention-days: 30

      # Upload Cucumber BDD Reports - ONLY reports we use
      - name: Upload Cucumber BDD Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cucumber-bdd-reports
          path: |
            cypress/reports/cucumber-report.html
            cypress/reports/cucumber-report.json
            cypress/reports/login/cucumber/
            cypress/reports/dashboard/cucumber/
            cypress/reports/payment_link/cucumber/
          retention-days: 30

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots-${{ github.run_number }}
          path: images/
          retention-days: 7
          if-no-files-found: ignore
        continue-on-error: true

      - name: Upload Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-videos-${{ github.run_number }}
          path: cypress/videos/
          retention-days: 7
          if-no-files-found: ignore
        continue-on-error: true

      # ============ COMBINED SLACK NOTIFICATION ============
      - name: Send Combined Slack Notification
        if: always()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_COLOR: ${{ steps.overall_results.outputs.overall_status == 'success' && '#00ff00' || '#ff0000' }}
          SLACK_ICON: https://github.com/PayRam.png
          SLACK_MESSAGE: |
            ${{ steps.overall_results.outputs.overall_emoji }} **PayRam E2E Test Execution Complete**
            
            ğŸ“Š **Overall Summary:**
            â€¢ **Total Test Cases:** ${{ steps.overall_results.outputs.overall_total }}
            â€¢ **Passed:** ${{ steps.overall_results.outputs.overall_passed }} âœ…
            â€¢ **Failed:** ${{ steps.overall_results.outputs.overall_failed }} âŒ
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            ğŸ” **Module Name:** Login Module
            â€¢ **Total Test Cases:** ${{ steps.login_results.outputs.total }}
            â€¢ **Passed:** ${{ steps.login_results.outputs.passed }} âœ…
            â€¢ **Failed:** ${{ steps.login_results.outputs.failed }} âŒ
            â€¢ **Status:** ${{ steps.login_results.outputs.status }}
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            ğŸ“Š **Module Name:** Dashboard Module
            â€¢ **Total Test Cases:** ${{ steps.dashboard_results.outputs.total }}
            â€¢ **Passed:** ${{ steps.dashboard_results.outputs.passed }} âœ…
            â€¢ **Failed:** ${{ steps.dashboard_results.outputs.failed }} âŒ
            â€¢ **Status:** ${{ steps.dashboard_results.outputs.status }}
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            ğŸ’³ **Module Name:** Payment Link Module
            â€¢ **Total Test Cases:** ${{ steps.payment_link_results.outputs.total }}
            â€¢ **Passed:** ${{ steps.payment_link_results.outputs.passed }} âœ…
            â€¢ **Failed:** ${{ steps.payment_link_results.outputs.failed }} âŒ
            â€¢ **Status:** ${{ steps.payment_link_results.outputs.status }}
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            ğŸ“ˆ **Detailed Test Reports Available:**
            ğŸ”— **Dashboard:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
            
            **Available Reports:**
            â€¢ ğŸ“Š **TDD Reports** - Detailed test execution with charts and statistics
            â€¢ ğŸ¥’ **BDD Reports** - Feature and scenario-based test results
            
            ğŸ’¡ *Sequential execution: Login â†’ Dashboard â†’ Payment Link*
            
            ğŸ”— **GitHub Actions Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SLACK_TITLE: 'ğŸš€ PayRam E2E Test Report - All Modules'
          SLACK_USERNAME: 'PayRam Test Bot'
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_FOOTER: 'Triggered by ${{ github.event_name }} | Branch: ${{ github.ref_name }} | Tests run every 6 hours'

      # ============ FAIL WORKFLOW IF TESTS FAILED ============
      - name: Fail Workflow if Tests Failed
        if: ${{ steps.overall_results.outputs.overall_failed != '0' }}
        run: |
          echo "âŒ TESTS FAILED: ${{ steps.overall_results.outputs.overall_failed }} test(s) failed out of ${{ steps.overall_results.outputs.overall_total }}"
          echo "Passed: ${{ steps.overall_results.outputs.overall_passed }}"
          echo "Report: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo ""
          echo "âš ï¸ This workflow is marked as FAILED to block deployment pipeline"
          exit 1
